<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>note アクセス解析ツール</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/modal.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1>📊 note アクセス解析ツール</h1>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- KPI Cards -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total-pv">-</div>
        <div class="stat-label">総PV</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-likes">-</div>
        <div class="stat-label">総スキ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-comments">-</div>
        <div class="stat-label">コメント</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-followers">-</div>
        <div class="stat-label">フォロワー</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-revenue">-</div>
        <div class="stat-label">売上</div>
      </div>
    </div>

    <!-- Data Actions Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">📥 データ取得</h2>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="sync-note-btn" onclick="syncFromNote()">
          🔄 noteから自動取得
        </button>
        <button class="btn btn-secondary" onclick="openNoteSettings()">
          ⚙️ 連携設定
        </button>
        <button class="btn btn-secondary" onclick="openStatsModal()">
          ✏️ フォロワー・売上入力
        </button>
        <button class="btn btn-secondary" onclick="openExportModal()">
          📤 CSVエクスポート
        </button>
      </div>
      <div class="sync-status" id="sync-status">
        <span id="last-sync-time">最終同期: -</span>
      </div>
    </div>

    <!-- Chart Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">📈 推移グラフ</h2>
        <div class="chart-controls">
          <div class="filter-tabs" id="chart-period-tabs">
            <button class="filter-tab active" data-period="daily">日別</button>
            <button class="filter-tab" data-period="weekly">週別</button>
            <button class="filter-tab" data-period="monthly">月別</button>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="analytics-chart"></canvas>
      </div>
    </div>

    <!-- Period Comparison Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">📊 期間比較</h2>
      </div>
      <div class="period-comparison">
        <div class="period-inputs">
          <div class="period-group">
            <label>期間1:</label>
            <input type="date" id="period1-start" class="form-input">
            <span>〜</span>
            <input type="date" id="period1-end" class="form-input">
          </div>
          <span class="vs-label">vs</span>
          <div class="period-group">
            <label>期間2:</label>
            <input type="date" id="period2-start" class="form-input">
            <span>〜</span>
            <input type="date" id="period2-end" class="form-input">
          </div>
          <button class="btn btn-primary btn-sm" onclick="comparePeriods()">比較</button>
        </div>
      </div>
      <div id="comparison-result"></div>
    </div>

    <!-- Article Stats Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">📋 記事別アクセス</h2>
      </div>
      <div class="table-container">
        <table class="data-table" id="article-stats-table">
          <thead>
            <tr>
              <th>記事名</th>
              <th>PV</th>
              <th>スキ</th>
              <th>コメント</th>
              <th>推移</th>
            </tr>
          </thead>
          <tbody id="article-stats-body">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
      <div class="empty-state" id="article-empty-state" style="display: none;">
        <div class="empty-state-icon">📭</div>
        <p>データがありません</p>
        <p>noteから自動取得してください</p>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Stats Input Modal (フォロワー・売上入力) -->
  <div class="modal-overlay" id="stats-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">フォロワー・売上入力</h3>
        <button class="modal-close" onclick="closeStatsModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">日付</label>
          <input type="date" id="stats-date" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">フォロワー数</label>
          <input type="number" id="stats-followers" class="form-input" placeholder="例: 1234">
        </div>
        <div class="form-group">
          <label class="form-label">売上（円）</label>
          <input type="number" id="stats-revenue" class="form-input" placeholder="例: 5000">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeStatsModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="saveStats()">保存</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="export-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">CSVエクスポート</h3>
        <button class="modal-close" onclick="closeExportModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">エクスポート形式</label>
          <select id="export-type" class="form-select">
            <option value="detail">詳細データ（記事×日付ごと）</option>
            <option value="summary">サマリー（記事ごとの累計）</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">期間（任意）</label>
          <div class="date-range">
            <input type="date" id="export-start" class="form-input">
            <span>〜</span>
            <input type="date" id="export-end" class="form-input">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeExportModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="executeExport()">エクスポート</button>
      </div>
    </div>
  </div>

  <!-- Note Settings Modal -->
  <div class="modal-overlay" id="note-settings-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">note連携設定</h3>
        <button class="modal-close" onclick="closeNoteSettings()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">note認証トークン (note_gql_auth_token)</label>
          <input type="password" id="note-auth-token" class="form-input" placeholder="Cookieから取得">
          <small class="form-hint">noteにログイン後、開発者ツールのCookieから取得してください</small>
        </div>
        <div class="form-group">
          <label class="form-label">noteセッション (_note_session_v5)</label>
          <input type="password" id="note-session" class="form-input" placeholder="Cookieから取得">
        </div>
        <div class="settings-help">
          <details>
            <summary>取得方法を見る</summary>
            <ol>
              <li>noteにログインする</li>
              <li>開発者ツール（F12）を開く</li>
              <li>Application → Cookies → note.com を選択</li>
              <li>note_gql_auth_token と _note_session_v5 の値をコピー</li>
            </ol>
          </details>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNoteSettings()">キャンセル</button>
        <button class="btn btn-primary" onclick="saveNoteSettings()">保存</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/note-settings.js"></script>
  <script src="js/note-sync.js"></script>
  <script src="js/analytics.js"></script>
  <script src="js/csv-export.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
