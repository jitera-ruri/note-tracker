<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>note åŸ·ç­†ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2cb696;
      --primary-dark: #239b7e;
      --primary-light: #e8f5f1;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #adb5bd;
      --gray-600: #6c757d;
      --gray-700: #495057;
      --gray-800: #343a40;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: white;
      padding: 16px 20px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.25rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-size: 1rem;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: var(--primary-light);
    }

    .tab:hover:not(.active) {
      background: var(--gray-100);
    }

    /* Main Content */
    .main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gray-800);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--gray-300);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 0.875rem;
      min-height: 40px;
    }

    .btn-icon {
      width: 48px;
      height: 48px;
      padding: 0;
      border-radius: 50%;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--gray-700);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: pointer;
    }

    /* Tags Input */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      min-height: 48px;
      align-items: center;
    }

    .tags-container:focus-within {
      border-color: var(--primary);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
    }

    .tag-remove {
      cursor: pointer;
      font-weight: bold;
      margin-left: 4px;
    }

    .tags-input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 100px;
      padding: 6px;
      font-size: 1rem;
    }

    /* Article List */
    .article-item {
      background: white;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .article-item:hover {
      transform: translateY(-2px);
    }

    .article-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .article-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .article-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .article-tag {
      background: var(--gray-200);
      color: var(--gray-700);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .article-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-draft {
      background: var(--warning);
      color: white;
    }

    .status-published {
      background: var(--success);
      color: white;
    }

    .status-archived {
      background: var(--gray-500);
      color: white;
    }

    /* Task Progress */
    .task-progress {
      display: flex;
      gap: 4px;
      margin-top: 12px;
    }

    .task-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      font-weight: bold;
    }

    .task-not_started {
      background: var(--gray-400);
    }

    .task-in_progress {
      background: var(--warning);
    }

    .task-completed {
      background: var(--success);
    }

    .task-skipped {
      background: var(--gray-500);
    }

    /* Gantt Chart */
    .gantt-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .gantt-container {
      overflow-x: auto;
      padding-bottom: 16px;
    }

    .gantt-table {
      min-width: 100%;
      border-collapse: collapse;
    }

    .gantt-table th,
    .gantt-table td {
      padding: 8px;
      border: 1px solid var(--gray-300);
      text-align: center;
      min-width: 40px;
    }

    .gantt-table th {
      background: var(--gray-200);
      font-weight: 500;
      position: sticky;
      top: 0;
    }

    .gantt-table .article-cell {
      text-align: left;
      min-width: 150px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gantt-bar {
      height: 24px;
      border-radius: 4px;
      min-width: 100%;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-600);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
    }

    .modal-footer .btn {
      flex: 1;
    }

    /* Task Editor */
    .task-editor {
      display: grid;
      gap: 12px;
    }

    .task-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--gray-100);
      border-radius: 8px;
    }

    .task-name {
      flex: 1;
      font-weight: 500;
    }

    .task-select {
      padding: 8px 12px;
      border: 2px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.9rem;
      min-width: 120px;
    }

    /* Analytics */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-top: 4px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 8px 16px;
      border: 2px solid var(--gray-300);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .filter-tab.active {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary);
    }

    /* CSV Import */
    .file-drop {
      border: 2px dashed var(--gray-400);
      border-radius: var(--radius);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-drop:hover,
    .file-drop.dragover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .file-drop-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* Date inputs */
    .date-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .date-row .form-group {
      flex: 1;
      min-width: 140px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-600);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-300);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .gantt-table .article-cell {
        min-width: 100px;
      }

      .modal {
        max-height: 100vh;
        border-radius: 0;
      }

      .task-row {
        flex-direction: column;
        align-items: stretch;
      }

      .task-select {
        width: 100%;
      }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-800);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    /* Period Comparison */
    .period-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }

    .period-selector label {
      font-weight: 500;
    }

    .vs-text {
      font-weight: bold;
      color: var(--gray-600);
    }

    /* Checkbox */
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px;
      background: var(--primary-light);
      border-radius: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-group label {
      cursor: pointer;
      font-weight: 500;
      color: var(--primary-dark);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ“ note åŸ·ç­†ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
  </header>

  <nav class="tabs">
    <div class="tab active" data-tab="progress">ğŸ“‹ åŸ·ç­†é€²æ—</div>
    <div class="tab" data-tab="analytics">ğŸ“Š ã‚¢ã‚¯ã‚»ã‚¹è§£æ</div>
  </nav>

  <main class="main">
    <!-- åŸ·ç­†é€²æ—ã‚¿ãƒ– -->
    <div id="progress-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">è¨˜äº‹ä¸€è¦§</h2>
          <button class="btn btn-primary" onclick="openArticleModal()">
            ï¼‹ æ–°è¦ä½œæˆ
          </button>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">ã™ã¹ã¦</button>
          <button class="filter-tab" data-filter="draft">ä¸‹æ›¸ã</button>
          <button class="filter-tab" data-filter="published">æŠ•ç¨¿æ¸ˆã¿</button>
          <button class="filter-tab" data-filter="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
        </div>

        <div id="article-list" class="article-list">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
          <div class="gantt-controls">
            <button class="btn btn-secondary btn-sm gantt-view active" data-view="week">é€±æ¬¡</button>
            <button class="btn btn-secondary btn-sm gantt-view" data-view="month">æœˆæ¬¡</button>
          </div>
        </div>
        <div class="gantt-container">
          <div id="gantt-chart"></div>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚»ã‚¹è§£æã‚¿ãƒ– -->
    <div id="analytics-tab" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-pv">-</div>
          <div class="stat-label">ç·PV</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-likes">-</div>
          <div class="stat-label">ç·ã‚¹ã‚­</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-comments">-</div>
          <div class="stat-label">ç·ã‚³ãƒ¡ãƒ³ãƒˆ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-followers">-</div>
          <div class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-revenue">-</div>
          <div class="stat-label">å£²ä¸Š</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="openCsvModal()">ğŸ“„ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-secondary" onclick="openStatsModal()">âœï¸ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ»å£²ä¸Šå…¥åŠ›</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
          <div class="filter-tabs">
            <button class="filter-tab active" data-chart="daily">æ—¥åˆ¥</button>
            <button class="filter-tab" data-chart="weekly">é€±åˆ¥</button>
            <button class="filter-tab" data-chart="monthly">æœˆåˆ¥</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="trend-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">æœŸé–“æ¯”è¼ƒ</h2>
        </div>
        <div class="period-selector">
          <label>æœŸé–“1:</label>
          <input type="month" id="period1" class="form-input" style="width: auto;">
          <span class="vs-text">vs</span>
          <label>æœŸé–“2:</label>
          <input type="month" id="period2" class="form-input" style="width: auto;">
          <button class="btn btn-primary btn-sm" onclick="comparePeriods()">æ¯”è¼ƒ</button>
        </div>
        <div class="chart-container">
          <canvas id="compare-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">è¨˜äº‹åˆ¥ã‚¢ã‚¯ã‚»ã‚¹</h2>
        </div>
        <div id="article-analytics-list"></div>
      </div>
    </div>
  </main>

  <!-- è¨˜äº‹ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="article-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="article-modal-title">æ–°è¦è¨˜äº‹ä½œæˆ</h3>
        <button class="modal-close" onclick="closeArticleModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="article-id">
        
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="article-title" class="form-input" placeholder="è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
        </div>

        <div class="form-group">
          <label class="form-label">ã‚¿ã‚°ï¼ˆEnterã§è¿½åŠ ï¼‰</label>
          <div class="tags-container" id="tags-container">
            <input type="text" class="tags-input" id="tags-input" placeholder="ã‚¿ã‚°ã‚’å…¥åŠ›...">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¹ã‚¯é€²æ—</label>
          <div class="task-editor" id="task-editor"></div>
        </div>

        <div class="form-group">
          <label class="form-label">è¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="article-status" class="form-select">
            <option value="draft">ä¸‹æ›¸ã</option>
            <option value="published">æŠ•ç¨¿æ¸ˆã¿</option>
            <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
          </select>
        </div>

        <div class="date-row">
          <div class="form-group">
            <label class="form-label">ä¸‹æ›¸ãä¿å­˜æ—¥</label>
            <input type="date" id="draft-saved-at" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">æŠ•ç¨¿æ—¥</label>
            <input type="date" id="published-at" class="form-input">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeArticleModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" id="delete-article-btn" onclick="deleteArticle()" style="display: none;">å‰Šé™¤</button>
        <button class="btn btn-primary" id="save-article-btn" onclick="saveArticle()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="csv-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
        <button class="modal-close" onclick="closeCsvModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--gray-600);">
          noteãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
        </p>
        <div class="file-drop" id="file-drop" onclick="document.getElementById('csv-file').click()">
          <div class="file-drop-icon">ğŸ“</div>
          <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
          <p style="font-size: 0.875rem; color: var(--gray-500);">CSVå½¢å¼</p>
        </div>
        <input type="file" id="csv-file" accept=".csv" style="display: none;" onchange="handleCsvFile(event)">
        
        <div id="csv-preview" style="margin-top: 16px; display: none;">
          <h4 style="margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
          <div id="csv-preview-content" style="max-height: 200px; overflow: auto; background: var(--gray-100); padding: 12px; border-radius: 8px; font-size: 0.875rem;"></div>
        </div>

        <div class="checkbox-group" id="update-status-group" style="display: none;">
          <input type="checkbox" id="update-draft-status" checked>
          <label for="update-draft-status">ä¸‹æ›¸ãè¨˜äº‹ã‚’ã€ŒæŠ•ç¨¿æ¸ˆã¿ã€ã«æ›´æ–°ã™ã‚‹</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCsvModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="import-csv-btn" onclick="importCsv()" disabled>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ»å£²ä¸Šå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="stats-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ»å£²ä¸Šå…¥åŠ›</h3>
        <button class="modal-close" onclick="closeStatsModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" id="stats-date" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°</label>
          <input type="number" id="stats-followers" class="form-input" placeholder="0">
        </div>
        <div class="form-group">
          <label class="form-label">å£²ä¸Šï¼ˆå††ï¼‰</label>
          <input type="number" id="stats-revenue" class="form-input" placeholder="0">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeStatsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="save-stats-btn" onclick="saveStats()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://vjgtoedqyxtumadjjixr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqZ3RvZWRxeXh0dW1hZGpqaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTQ2OTMsImV4cCI6MjA4MDM5MDY5M30.CLom_qAan2Av94VBr4qUnPTKd5iUQwcSPnqRYkkkak4';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ã‚¿ã‚¹ã‚¯å®šç¾©
    const TASKS = [
      { type: 'planning', name: 'ä¼ç”»', order: 1, required: true },
      { type: 'writing', name: 'åŸ·ç­†', order: 2, required: true },
      { type: 'proofreading', name: 'æ ¡æ­£', order: 3, required: true },
      { type: 'thumbnail', name: 'ã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆ', order: 4, required: true },
      { type: 'image', name: 'ç”»åƒè²¼ã‚Šä»˜ã‘', order: 5, required: false },
      { type: 'affiliate', name: 'ã‚¢ãƒ•ã‚§ãƒªã‚¨ã‚¤ãƒˆè²¼ã‚Šä»˜ã‘', order: 6, required: false }
    ];

    const TASK_STATUSES = [
      { value: 'not_started', label: 'æœªç€æ‰‹' },
      { value: 'in_progress', label: 'é€²è¡Œä¸­' },
      { value: 'completed', label: 'å®Œäº†' },
      { value: 'skipped', label: 'ã‚¹ã‚­ãƒƒãƒ—' }
    ];

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let articles = [];
    let currentTags = [];
    let currentTasks = {};
    let csvData = null;
    let csvDraftArticles = [];
    let trendChart = null;
    let compareChart = null;
    let currentFilter = 'all';
    let currentGanttView = 'week';
    let currentChartView = 'daily';
    let isProcessing = false;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      initFilterTabs();
      initTagsInput();
      initFileDrop();
      initGanttControls();
      initChartFilters();
      loadArticles();
      loadAnalytics();
      
      // æ—¥ä»˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      document.getElementById('stats-date').value = new Date().toISOString().split('T')[0];
      
      // æœŸé–“æ¯”è¼ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      document.getElementById('period1').value = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('period2').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function initTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–
    function initFilterTabs() {
      document.querySelectorAll('.filter-tabs').forEach(container => {
        container.querySelectorAll('.filter-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            container.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            if (tab.dataset.filter) {
              currentFilter = tab.dataset.filter;
              renderArticles();
            }
            if (tab.dataset.chart) {
              currentChartView = tab.dataset.chart;
              updateTrendChart();
            }
          });
        });
      });
    }

    // ã‚¿ã‚°å…¥åŠ›
    function initTagsInput() {
      const input = document.getElementById('tags-input');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          e.preventDefault();
          addTag(input.value.trim());
          input.value = '';
        }
      });
    }

    function addTag(tag) {
      if (!currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTags();
      }
    }

    function removeTag(tag) {
      currentTags = currentTags.filter(t => t !== tag);
      renderTags();
    }

    function renderTags() {
      const container = document.getElementById('tags-container');
      const input = document.getElementById('tags-input');
      container.innerHTML = '';
      currentTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag';
        tagEl.innerHTML = `${tag}<span class="tag-remove" onclick="removeTag('${tag}')">Ã—</span>`;
        container.appendChild(tagEl);
      });
      container.appendChild(input);
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—
    function initFileDrop() {
      const dropZone = document.getElementById('file-drop');
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
          processCsvFile(file);
        }
      });
    }

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    function initGanttControls() {
      document.querySelectorAll('.gantt-view').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.gantt-view').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentGanttView = btn.dataset.view;
          renderGanttChart();
        });
      });
    }

    // ãƒãƒ£ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    function initChartFilters() {
      // åˆæœŸåŒ–æ™‚ã«è¨­å®šæ¸ˆã¿
    }

    // è¨˜äº‹èª­ã¿è¾¼ã¿
    async function loadArticles() {
      try {
        const { data, error } = await supabase
          .from('articles')
          .select('*, tasks(*)')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        articles = data || [];
        renderArticles();
        renderGanttChart();
      } catch (error) {
        console.error('Error loading articles:', error);
        showToast('è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // è¨˜äº‹ä¸€è¦§è¡¨ç¤º
    function renderArticles() {
      const container = document.getElementById('article-list');
      let filtered = articles;
      
      if (currentFilter !== 'all') {
        filtered = articles.filter(a => a.status === currentFilter);
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <p>è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(article => {
        const tasks = article.tasks || [];
        return `
          <div class="article-item" onclick="openArticleModal('${article.id}')">
            <div class="article-title">${escapeHtml(article.title)}</div>
            <div class="article-meta">
              <span class="article-status status-${article.status}">
                ${article.status === 'draft' ? 'ä¸‹æ›¸ã' : article.status === 'published' ? 'æŠ•ç¨¿æ¸ˆã¿' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}
              </span>
              ${article.published_at ? `<span style="color: var(--gray-600); font-size: 0.875rem;">æŠ•ç¨¿: ${formatDate(article.published_at)}</span>` : ''}
            </div>
            <div class="article-tags">
              ${(article.tags || []).map(tag => `<span class="article-tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
            <div class="task-progress">
              ${TASKS.map(t => {
                const task = tasks.find(at => at.task_type === t.type);
                const status = task ? task.task_status : 'not_started';
                return `<div class="task-dot task-${status}" title="${t.name}: ${getStatusLabel(status)}">${t.name.charAt(0)}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
    function renderGanttChart() {
      const container = document.getElementById('gantt-chart');
      const activeArticles = articles.filter(a => a.status !== 'archived');
      
      if (activeArticles.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <p>è¡¨ç¤ºã™ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }
      
      // æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
      const today = new Date();
      let startDate, endDate, dateLabels;
      
      if (currentGanttView === 'week') {
        // ä»Šé€±ã®æœˆæ›œæ—¥ã‹ã‚‰æ—¥æ›œæ—¥
        const dayOfWeek = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        startDate = monday;
        endDate = new Date(monday);
        endDate.setDate(monday.getDate() + 6);
        
        dateLabels = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          dateLabels.push({
            date: new Date(d),
            label: `${d.getMonth() + 1}/${d.getDate()}`
          });
        }
      } else {
        // ä»Šæœˆ
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        dateLabels = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          dateLabels.push({
            date: new Date(d),
            label: d.getDate().toString()
          });
        }
      }
      
      let html = `
        <table class="gantt-table">
          <thead>
            <tr>
              <th class="article-cell">è¨˜äº‹</th>
              ${dateLabels.map(d => `<th>${d.label}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
      `;
      
      activeArticles.forEach(article => {
        const tasks = article.tasks || [];
        const inProgressTask = tasks.find(t => t.task_status === 'in_progress');
        const completedTasks = tasks.filter(t => t.task_status === 'completed').length;
        const totalTasks = TASKS.filter(t => t.required).length;
        const progress = Math.round((completedTasks / totalTasks) * 100);
        
        html += `
          <tr>
            <td class="article-cell" title="${escapeHtml(article.title)}">${escapeHtml(article.title)}</td>
            ${dateLabels.map(d => {
              const dateStr = d.date.toISOString().split('T')[0];
              const createdDate = article.created_at.split('T')[0];
              const publishedDate = article.published_at ? article.published_at.split('T')[0] : null;
              
              let bgColor = 'transparent';
              if (dateStr >= createdDate && (!publishedDate || dateStr <= publishedDate)) {
                if (progress === 100) {
                  bgColor = 'var(--success)';
                } else if (progress > 0) {
                  bgColor = 'var(--warning)';
                } else {
                  bgColor = 'var(--gray-300)';
                }
              }
              
              return `<td><div class="gantt-bar" style="background: ${bgColor};"></div></td>`;
            }).join('')}
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // è¨˜äº‹ãƒ¢ãƒ¼ãƒ€ãƒ«
    async function openArticleModal(articleId = null) {
      const modal = document.getElementById('article-modal');
      const title = document.getElementById('article-modal-title');
      const deleteBtn = document.getElementById('delete-article-btn');
      
      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('article-id').value = '';
      document.getElementById('article-title').value = '';
      document.getElementById('article-status').value = 'draft';
      document.getElementById('draft-saved-at').value = '';
      document.getElementById('published-at').value = '';
      currentTags = [];
      currentTasks = {};
      
      if (articleId) {
        title.textContent = 'è¨˜äº‹ã‚’ç·¨é›†';
        deleteBtn.style.display = 'block';
        
        const article = articles.find(a => a.id === articleId);
        if (article) {
          document.getElementById('article-id').value = article.id;
          document.getElementById('article-title').value = article.title;
          document.getElementById('article-status').value = article.status;
          document.getElementById('draft-saved-at').value = article.draft_saved_at ? article.draft_saved_at.split('T')[0] : '';
          document.getElementById('published-at').value = article.published_at ? article.published_at.split('T')[0] : '';
          currentTags = article.tags || [];
          
          (article.tasks || []).forEach(task => {
            currentTasks[task.task_type] = task.task_status;
          });
        }
      } else {
        title.textContent = 'æ–°è¦è¨˜äº‹ä½œæˆ';
        deleteBtn.style.display = 'none';
        document.getElementById('draft-saved-at').value = new Date().toISOString().split('T')[0];
      }
      
      renderTags();
      renderTaskEditor();
      modal.classList.add('active');
    }

    function closeArticleModal() {
      document.getElementById('article-modal').classList.remove('active');
    }

    function renderTaskEditor() {
      const container = document.getElementById('task-editor');
      container.innerHTML = TASKS.map(task => {
        const status = currentTasks[task.type] || 'not_started';
        return `
          <div class="task-row">
            <span class="task-name">${task.name}${task.required ? '' : 'ï¼ˆä»»æ„ï¼‰'}</span>
            <select class="task-select" data-task="${task.type}">
              ${TASK_STATUSES.map(s => `
                <option value="${s.value}" ${status === s.value ? 'selected' : ''}>${s.label}</option>
              `).join('')}
            </select>
          </div>
        `;
      }).join('');
    }

    async function saveArticle() {
      if (isProcessing) return;
      
      const id = document.getElementById('article-id').value;
      const title = document.getElementById('article-title').value.trim();
      const status = document.getElementById('article-status').value;
      const draftSavedAt = document.getElementById('draft-saved-at').value || null;
      const publishedAt = document.getElementById('published-at').value || null;
      
      if (!title) {
        showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
      isProcessing = true;
      const saveBtn = document.getElementById('save-article-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      
      // ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åé›†
      const taskStatuses = {};
      document.querySelectorAll('.task-select').forEach(select => {
        taskStatuses[select.dataset.task] = select.value;
      });
      
      try {
        let articleId = id;
        
        if (id) {
          // æ›´æ–°
          const { error } = await supabase
            .from('articles')
            .update({
              title,
              tags: currentTags,
              status,
              draft_saved_at: draftSavedAt,
              published_at: publishedAt,
              updated_at: new Date().toISOString()
            })
            .eq('id', id);
          
          if (error) throw error;
          
          // ã‚¿ã‚¹ã‚¯æ›´æ–°
          await supabase.from('tasks').delete().eq('article_id', id);
        } else {
          // æ–°è¦ä½œæˆ
          const { data, error } = await supabase
            .from('articles')
            .insert({
              title,
              tags: currentTags,
              status,
              draft_saved_at: draftSavedAt,
              published_at: publishedAt
            })
            .select()
            .single();
          
          if (error) throw error;
          articleId = data.id;
        }
        
        // ã‚¿ã‚¹ã‚¯ä½œæˆ
        const tasksToInsert = TASKS.map(task => ({
          article_id: articleId,
          task_type: task.type,
          task_status: taskStatuses[task.type] || 'not_started',
          task_order: task.order
        }));
        
        const { error: taskError } = await supabase
          .from('tasks')
          .insert(tasksToInsert);
        
        if (taskError) throw taskError;
        
        showToast('ä¿å­˜ã—ã¾ã—ãŸ');
        closeArticleModal();
        loadArticles();
      } catch (error) {
        console.error('Error saving article:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        isProcessing = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'ä¿å­˜';
      }
    }

    async function deleteArticle() {
      if (isProcessing) return;
      
      const id = document.getElementById('article-id').value;
      if (!id) return;
      
      if (!confirm('ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      isProcessing = true;
      
      try {
        const { error } = await supabase
          .from('articles')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
        closeArticleModal();
        loadArticles();
      } catch (error) {
        console.error('Error deleting article:', error);
        showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        isProcessing = false;
      }
    }

    // CSVãƒ¢ãƒ¼ãƒ€ãƒ«
    function openCsvModal() {
      document.getElementById('csv-modal').classList.add('active');
      csvData = null;
      csvDraftArticles = [];
      document.getElementById('csv-preview').style.display = 'none';
      document.getElementById('update-status-group').style.display = 'none';
      document.getElementById('import-csv-btn').disabled = true;
      document.getElementById('csv-file').value = '';
    }

    function closeCsvModal() {
      document.getElementById('csv-modal').classList.remove('active');
    }

    function handleCsvFile(event) {
      const file = event.target.files[0];
      if (file) {
        processCsvFile(file);
      }
    }

    async function processCsvFile(file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
          return;
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] || '';
          });
          data.push(row);
        }
        
        csvData = data;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const preview = document.getElementById('csv-preview');
        const content = document.getElementById('csv-preview-content');
        preview.style.display = 'block';
        content.innerHTML = `
          <p><strong>${data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</strong></p>
          <p>ã‚«ãƒ©ãƒ : ${headers.join(', ')}</p>
          <hr style="margin: 8px 0;">
          ${data.slice(0, 3).map(row => `<p>${JSON.stringify(row)}</p>`).join('')}
          ${data.length > 3 ? '<p>...</p>' : ''}
        `;
        
        // CSVã«å«ã¾ã‚Œã‚‹è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
        const csvTitles = [...new Set(data.map(row => 
          (row['è¨˜äº‹å'] || row['ã‚¿ã‚¤ãƒˆãƒ«'] || row['title'] || '').trim()
        ).filter(t => t))];
        
        // ä¸‹æ›¸ãçŠ¶æ…‹ã®è¨˜äº‹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const { data: draftArticles } = await supabase
          .from('articles')
          .select('id, title')
          .eq('status', 'draft')
          .in('title', csvTitles);
        
        csvDraftArticles = draftArticles || [];
        
        // ä¸‹æ›¸ãè¨˜äº‹ãŒã‚ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
        const updateStatusGroup = document.getElementById('update-status-group');
        if (csvDraftArticles.length > 0) {
          updateStatusGroup.style.display = 'flex';
          updateStatusGroup.querySelector('label').textContent = 
            `ä¸‹æ›¸ãè¨˜äº‹ï¼ˆ${csvDraftArticles.length}ä»¶ï¼‰ã‚’ã€ŒæŠ•ç¨¿æ¸ˆã¿ã€ã«æ›´æ–°ã™ã‚‹`;
        } else {
          updateStatusGroup.style.display = 'none';
        }
        
        document.getElementById('import-csv-btn').disabled = false;
      };
      reader.readAsText(file);
    }

async function importCsv() {
  if (!csvData || csvData.length === 0 || isProcessing) return;
  
  // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  isProcessing = true;
  const importBtn = document.getElementById('import-csv-btn');
  importBtn.disabled = true;
  importBtn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...';
  
  try {
    const updateDraftStatus = document.getElementById('update-draft-status').checked;
    
    // CSVãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    const analyticsData = csvData.map(row => {
      return {
        date: row['æ—¥ä»˜'] || row['date'] || new Date().toISOString().split('T')[0],
        article_title: (row['è¨˜äº‹å'] || row['ã‚¿ã‚¤ãƒˆãƒ«'] || row['title'] || '').trim(),
        pv: parseInt(row['PV'] || row['ãƒ“ãƒ¥ãƒ¼'] || row['pv'] || 0) || 0,
        likes: parseInt(row['ã‚¹ã‚­'] || row['ã„ã„ã­'] || row['likes'] || 0) || 0,
        comments: parseInt(row['ã‚³ãƒ¡ãƒ³ãƒˆ'] || row['comments'] || 0) || 0
      };
    });
    
    // è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const uniqueTitles = [...new Set(analyticsData.map(d => d.article_title).filter(t => t))];
    const articleIdMap = {};
    
    // æ—¢å­˜ã®è¨˜äº‹ã‚’ä¸€æ‹¬å–å¾—
    const { data: existingArticles } = await supabase
      .from('articles')
      .select('id, title, status')
      .in('title', uniqueTitles);
    
    (existingArticles || []).forEach(a => {
      articleIdMap[a.title] = a.id;
    });
    
    // ä¸‹æ›¸ãè¨˜äº‹ã‚’æŠ•ç¨¿æ¸ˆã¿ã«æ›´æ–°
    if (updateDraftStatus && csvDraftArticles.length > 0) {
      const draftIds = csvDraftArticles.map(a => a.id);
      await supabase
        .from('articles')
        .update({ 
          status: 'published',
          published_at: new Date().toISOString()
        })
        .in('id', draftIds);
    }
    
    // å­˜åœ¨ã—ãªã„è¨˜äº‹ã‚’ä½œæˆ
    const newTitles = uniqueTitles.filter(t => !articleIdMap[t]);
    if (newTitles.length > 0) {
      const { data: newArticles } = await supabase
        .from('articles')
        .insert(newTitles.map(title => ({ title, status: 'published' })))
        .select();
      
      (newArticles || []).forEach(a => {
        articleIdMap[a.title] = a.id;
      });
      
      // æ–°è¦è¨˜äº‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
      const tasksToInsert = [];
      (newArticles || []).forEach(article => {
        TASKS.forEach(task => {
          tasksToInsert.push({
            article_id: article.id,
            task_type: task.type,
            task_status: 'completed',
            task_order: task.order
          });
        });
      });
      if (tasksToInsert.length > 0) {
        await supabase.from('tasks').insert(tasksToInsert);
      }
    }
    
    // è¨˜äº‹ã”ã¨ãƒ»æ—¥ä»˜ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ï¼ˆåŒã˜è¨˜äº‹ãƒ»æ—¥ä»˜ã¯æœ€æ–°å€¤ã§ä¸Šæ›¸ãï¼‰
    const dataByArticleDate = {};
    analyticsData.forEach(d => {
      if (!d.article_title || !articleIdMap[d.article_title]) return;
      const articleId = articleIdMap[d.article_title];
      const key = `${articleId}_${d.date}`;
      dataByArticleDate[key] = {
        articleId,
        date: d.date,
        pv: d.pv,
        likes: d.likes,
        comments: d.comments
      };
    });
    
    // è¨˜äº‹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const dataByArticle = {};
    Object.values(dataByArticleDate).forEach(d => {
      if (!dataByArticle[d.articleId]) {
        dataByArticle[d.articleId] = [];
      }
      dataByArticle[d.articleId].push(d);
    });
    
    // å„è¨˜äº‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜æ˜‡é †ã«ã‚½ãƒ¼ãƒˆ
    Object.keys(dataByArticle).forEach(articleId => {
      dataByArticle[articleId].sort((a, b) => new Date(a.date) - new Date(b.date));
    });
    
    // å¢—åˆ†ã‚’è¨ˆç®—ã—ã¦upsertç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const analyticsToUpsert = [];
    
    Object.keys(dataByArticle).forEach(articleId => {
      const records = dataByArticle[articleId];
      
      for (let i = 0; i < records.length; i++) {
        const current = records[i];
        
        let deltaPv, deltaLikes, deltaComments;
        
        if (i === 0) {
          // æœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼šãã®ã¾ã¾ã®å€¤ã‚’ä½¿ç”¨
          deltaPv = current.pv;
          deltaLikes = current.likes;
          deltaComments = current.comments;
        } else {
          // 2ç•ªç›®ä»¥é™ï¼šå‰ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã®å·®åˆ†
          const prev = records[i - 1];
          deltaPv = Math.max(0, current.pv - prev.pv);
          deltaLikes = Math.max(0, current.likes - prev.likes);
          deltaComments = Math.max(0, current.comments - prev.comments);
        }
        
        analyticsToUpsert.push({
          article_id: articleId,
          date: current.date,
          pv: deltaPv,
          likes: deltaLikes,
          comments: deltaComments
        });
      }
    });
    
    if (analyticsToUpsert.length > 0) {
      await supabase
        .from('article_analytics')
        .upsert(analyticsToUpsert, { onConflict: 'article_id,date' });
    }
    
    let message = `${analyticsToUpsert.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
    if (updateDraftStatus && csvDraftArticles.length > 0) {
      message += `ï¼ˆ${csvDraftArticles.length}ä»¶ã‚’æŠ•ç¨¿æ¸ˆã¿ã«æ›´æ–°ï¼‰`;
    }
    
    showToast(message);
    closeCsvModal();
    loadArticles();
    loadAnalytics();
  } catch (error) {
    console.error('Error importing CSV:', error);
    showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    isProcessing = false;
    importBtn.disabled = false;
    importBtn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
  }
}


    // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ»å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«
    function openStatsModal() {
      document.getElementById('stats-modal').classList.add('active');
      document.getElementById('stats-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('stats-followers').value = '';
      document.getElementById('stats-revenue').value = '';
    }

    function closeStatsModal() {
      document.getElementById('stats-modal').classList.remove('active');
    }

    async function saveStats() {
      if (isProcessing) return;
      
      const date = document.getElementById('stats-date').value;
      const followers = parseInt(document.getElementById('stats-followers').value) || 0;
      const revenue = parseInt(document.getElementById('stats-revenue').value) || 0;
      
      if (!date) {
        showToast('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
      isProcessing = true;
      const saveBtn = document.getElementById('save-stats-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      
      try {
        const { error } = await supabase
          .from('overall_stats')
          .upsert({ date, followers, revenue }, { onConflict: 'date' });
        
        if (error) throw error;
        
        showToast('ä¿å­˜ã—ã¾ã—ãŸ');
        closeStatsModal();
        loadAnalytics();
      } catch (error) {
        console.error('Error saving stats:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        isProcessing = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'ä¿å­˜';
      }
    }

    // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹èª­ã¿è¾¼ã¿
    async function loadAnalytics() {
      try {
        // è¨˜äº‹åˆ¥ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹
        const { data: articleAnalytics } = await supabase
          .from('article_analytics')
          .select('*, articles(title)')
          .order('date', { ascending: false });
        
        // å…¨ä½“çµ±è¨ˆ
        const { data: overallStats } = await supabase
          .from('overall_stats')
          .select('*')
          .order('date', { ascending: false });
        
        // é›†è¨ˆ
        const totals = {
          pv: 0,
          likes: 0,
          comments: 0,
          followers: overallStats?.[0]?.followers || 0,
          revenue: 0
        };
        
        (articleAnalytics || []).forEach(a => {
          totals.pv += a.pv || 0;
          totals.likes += a.likes || 0;
          totals.comments += a.comments || 0;
        });
        
        (overallStats || []).forEach(s => {
          totals.revenue += s.revenue || 0;
        });
        
        // è¡¨ç¤ºæ›´æ–°
        document.getElementById('total-pv').textContent = totals.pv.toLocaleString();
        document.getElementById('total-likes').textContent = totals.likes.toLocaleString();
        document.getElementById('total-comments').textContent = totals.comments.toLocaleString();
        document.getElementById('total-followers').textContent = totals.followers.toLocaleString();
        document.getElementById('total-revenue').textContent = `Â¥${totals.revenue.toLocaleString()}`;
        
        // ã‚°ãƒ©ãƒ•æ›´æ–°
        updateTrendChart(articleAnalytics || []);
        
        // è¨˜äº‹åˆ¥ä¸€è¦§
        renderArticleAnalytics(articleAnalytics || []);
        
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function updateTrendChart(data) {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      
      if (trendChart) {
        trendChart.destroy();
      }
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      (data || []).forEach(item => {
        let key;
        const date = new Date(item.date);
        
        if (currentChartView === 'daily') {
          key = item.date;
        } else if (currentChartView === 'weekly') {
          const weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        } else {
          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        if (!grouped[key]) {
          grouped[key] = { pv: 0, likes: 0, comments: 0 };
        }
        grouped[key].pv += item.pv || 0;
        grouped[key].likes += item.likes || 0;
        grouped[key].comments += item.comments || 0;
      });
      
      const labels = Object.keys(grouped).sort();
      const pvData = labels.map(l => grouped[l].pv);
      const likesData = labels.map(l => grouped[l].likes);
      const commentsData = labels.map(l => grouped[l].comments);
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'PV',
              data: pvData,
              borderColor: '#2cb696',
              backgroundColor: 'rgba(44, 182, 150, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'ã‚¹ã‚­',
              data: likesData,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'ã‚³ãƒ¡ãƒ³ãƒˆ',
              data: commentsData,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    async function comparePeriods() {
      const period1 = document.getElementById('period1').value;
      const period2 = document.getElementById('period2').value;
      
      if (!period1 || !period2) {
        showToast('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const [year1, month1] = period1.split('-').map(Number);
        const [year2, month2] = period2.split('-').map(Number);
        
        const start1 = `${period1}-01`;
        const end1 = `${period1}-${new Date(year1, month1, 0).getDate()}`;
        const start2 = `${period2}-01`;
        const end2 = `${period2}-${new Date(year2, month2, 0).getDate()}`;
        
        const { data: data1 } = await supabase
          .from('article_analytics')
          .select('*')
          .gte('date', start1)
          .lte('date', end1);
        
        const { data: data2 } = await supabase
          .from('article_analytics')
          .select('*')
          .gte('date', start2)
          .lte('date', end2);
        
        const totals1 = { pv: 0, likes: 0, comments: 0 };
        const totals2 = { pv: 0, likes: 0, comments: 0 };
        
        (data1 || []).forEach(d => {
          totals1.pv += d.pv || 0;
          totals1.likes += d.likes || 0;
          totals1.comments += d.comments || 0;
        });
        
        (data2 || []).forEach(d => {
          totals2.pv += d.pv || 0;
          totals2.likes += d.likes || 0;
          totals2.comments += d.comments || 0;
        });
        
        const ctx = document.getElementById('compare-chart').getContext('2d');
        
        if (compareChart) {
          compareChart.destroy();
        }
        
        compareChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['PV', 'ã‚¹ã‚­', 'ã‚³ãƒ¡ãƒ³ãƒˆ'],
            datasets: [
              {
                label: period1,
                data: [totals1.pv, totals1.likes, totals1.comments],
                backgroundColor: 'rgba(44, 182, 150, 0.7)'
              },
              {
                label: period2,
                data: [totals2.pv, totals2.likes, totals2.comments],
                backgroundColor: 'rgba(52, 152, 219, 0.7)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
        
      } catch (error) {
        console.error('Error comparing periods:', error);
        showToast('æ¯”è¼ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function renderArticleAnalytics(data) {
      const container = document.getElementById('article-analytics-list');
      
      // è¨˜äº‹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const byArticle = {};
      data.forEach(item => {
        const title = item.articles?.title || 'ä¸æ˜';
        if (!byArticle[title]) {
          byArticle[title] = { pv: 0, likes: 0, comments: 0 };
        }
        byArticle[title].pv += item.pv || 0;
        byArticle[title].likes += item.likes || 0;
        byArticle[title].comments += item.comments || 0;
      });
      
      const sorted = Object.entries(byArticle).sort((a, b) => b[1].pv - a[1].pv);
      
      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = sorted.map(([title, stats]) => `
        <div class="article-item" style="cursor: default;">
          <div class="article-title">${escapeHtml(title)}</div>
          <div style="display: flex; gap: 16px; margin-top: 8px;">
            <span style="color: var(--primary);"><strong>${stats.pv.toLocaleString()}</strong> PV</span>
            <span style="color: var(--danger);"><strong>${stats.likes.toLocaleString()}</strong> ã‚¹ã‚­</span>
            <span style="color: #3498db;"><strong>${stats.comments.toLocaleString()}</strong> ã‚³ãƒ¡ãƒ³ãƒˆ</span>
          </div>
        </div>
      `).join('');
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    }

    function getStatusLabel(status) {
      const found = TASK_STATUSES.find(s => s.value === status);
      return found ? found.label : status;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
